openapi: 3.0.3
info:
  title: Dungeon Service API
  description: Dungeon runs and room management
  version: 1.0.0

servers:
  - url: http://localhost:3005/api

tags:
  - name: Dungeons

paths:

  /dungeons:
    get:
      tags: [Dungeons]
      summary: List all dungeons
      responses:
        200:
          description: Dungeon runs
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DungeonRun'



  /dungeons/start:
    post:
      tags: [Dungeons]
      summary: Start a dungeon run
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StartDungeonRequest'
      responses:
        201:
          description: Dungeon run created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DungeonRun'
        409:
          description: Dungeon run already in progress for this hero

  /dungeons/{runId}:
    get:
      tags: [Dungeons]
      summary: Get dungeon run
      parameters:
        - $ref: '#/components/parameters/RunId'
      responses:
        200:
          description: Dungeon run
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DungeonRun'

  /dungeons/{runId}/choices:
    get:
      tags: [Dungeons]
      summary: Get available room choices
      parameters:
        - $ref: '#/components/parameters/RunId'
      responses:
        200:
          description: Available room choices
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RoomChoices'

  /dungeons/{runId}/choose:
    post:
      tags: [Dungeons]
      summary: Choose next room from available options
      parameters:
        - $ref: '#/components/parameters/RunId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChooseRoomRequest'
      responses:
        200:
          description: Room chosen and entered

  /dungeons/{runId}/finish:
    post:
      tags: [Dungeons]
      summary: Finish dungeon run
      parameters:
        - $ref: '#/components/parameters/RunId'
      responses:
        200:
          description: Dungeon completed

components:

  parameters:
    RunId:
      name: runId
      in: path
      required: true
      schema:
        type: string

  schemas:

    StartDungeonRequest:
      type: object
      required:
        - heroId
      properties:
        heroId:
          type: string
        equippedArtifacts:
          type: array
          items:
            $ref: '#/components/schemas/EquippedArtifact'

    DungeonRun:
      type: object
      properties:
        runId:
          type: string
        heroId:
          type: string
        status:
          type: string
        position:
          $ref: '#/components/schemas/Position'
        rooms:
          type: array
          items:
            $ref: '#/components/schemas/DungeonRoom'

    Position:
      type: object
      properties:
        floor:
          type: integer
        room:
          type: integer

    DungeonRoom:
      type: object
      properties:
        floor:
          type: integer
        room:
          type: integer
        type:
          type: string
        monsterId:
          type: string

    RoomChoice:
      type: object
      properties:
        floor:
          type: integer
        room:
          type: integer
        type:
          type: string

    RoomChoices:
      type: object
      properties:
        choices:
          type: array
          items:
            $ref: '#/components/schemas/RoomChoice'
          minItems: 0
          maxItems: 2

    HeroStatsSnapshot:
      type: object
      properties:
        level:
          type: integer
        xp:
          type: integer
        stats:
          type: object
          properties:
            hp:
              type: integer
            current_hp:
              type: integer
              description: Current HP of the hero (used for damage calculations)
            att:
              type: integer
            def:
              type: integer
            regen:
              type: integer

    EquippedArtifact:
      type: object
      properties:
        id:
          type: string
        hp_buff:
          type: integer
        att_buff:
          type: integer
        def_buff:
          type: integer
        regen_buff:
          type: integer

    ChooseRoomRequest:
      type: object
      required:
        - choiceIndex
        - heroStats
      properties:
        choiceIndex:
          type: integer
          description: Index of the chosen room (0 or 1)
          enum: [0, 1]
        heroStats:
          type: object
          required:
            - hp
            - current_hp
            - att
            - def
            - regen
          properties:
            hp:
              type: integer
              description: Maximum HP (calculated with artifact bonuses)
            current_hp:
              type: integer
              description: Current HP (damage taken during dungeon)
            att:
              type: integer
              description: Attack stat (calculated with artifact bonuses)
            def:
              type: integer
              description: Defense stat (calculated with artifact bonuses)
            regen:
              type: integer
              description: Regeneration stat (calculated with artifact bonuses)
